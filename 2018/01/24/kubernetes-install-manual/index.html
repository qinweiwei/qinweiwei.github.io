<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>手动安装kubernetes | 青柠檬老爸的blog</title><meta name="description" content="手动安装kubernetes"><meta name="keywords" content="kubernetes"><meta name="author" content="Eric Qin"><meta name="copyright" content="Eric Qin"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/lemon.png"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="手动安装kubernetes"><meta name="twitter:description" content="手动安装kubernetes"><meta name="twitter:image" content="https://cdn.pixabay.com/photo/2017/01/15/22/38/in-winter-forest-1982920_1280.jpg"><meta property="og:type" content="article"><meta property="og:title" content="手动安装kubernetes"><meta property="og:url" content="http://yoursite.com/2018/01/24/kubernetes-install-manual/"><meta property="og:site_name" content="青柠檬老爸的blog"><meta property="og:description" content="手动安装kubernetes"><meta property="og:image" content="https://cdn.pixabay.com/photo/2017/01/15/22/38/in-winter-forest-1982920_1280.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2018/01/24/kubernetes-install-manual/"><link rel="prev" title="kubernetes集群中calico网络不通的问题定位过程记录" href="http://yoursite.com/2018/02/16/kubernetes-calico-network-location-progress/"><link rel="next" title="kubeadm源码分析" href="http://yoursite.com/2018/01/15/kubeadm-source-analysis/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">青柠檬老爸的blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/lemon.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">16</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">13</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#手动安装kubernetes集群"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">手动安装kubernetes集群</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#环境准备"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">环境准备</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#创建TLS证书和秘钥"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">创建TLS证书和秘钥</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#生成的-CA-证书和秘钥文件如下："><span class="toc_mobile_items-number">1.2.1.</span> <span class="toc_mobile_items-text">生成的 CA 证书和秘钥文件如下：</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#使用证书的组件如下："><span class="toc_mobile_items-number">1.2.2.</span> <span class="toc_mobile_items-text">使用证书的组件如下：</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#使用cfssl工具构建证书"><span class="toc_mobile_items-number">1.2.3.</span> <span class="toc_mobile_items-text">使用cfssl工具构建证书</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#安装cfssl工具"><span class="toc_mobile_items-number">1.2.3.1.</span> <span class="toc_mobile_items-text">安装cfssl工具</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#创建-CA-Certificate-Authority"><span class="toc_mobile_items-number">1.2.3.2.</span> <span class="toc_mobile_items-text">创建 CA (Certificate Authority)</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#创建-kubernetes-证书"><span class="toc_mobile_items-number">1.2.3.3.</span> <span class="toc_mobile_items-text">创建 kubernetes 证书</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#创建-admin-证书"><span class="toc_mobile_items-number">1.2.3.4.</span> <span class="toc_mobile_items-text">创建 admin 证书</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#创建-kube-proxy-证书"><span class="toc_mobile_items-number">1.2.3.5.</span> <span class="toc_mobile_items-text">创建 kube-proxy 证书</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#校验证书"><span class="toc_mobile_items-number">1.2.3.6.</span> <span class="toc_mobile_items-text">校验证书</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#分发证书"><span class="toc_mobile_items-number">1.2.3.7.</span> <span class="toc_mobile_items-text">分发证书</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#使用openssl工具构建证书和秘钥"><span class="toc_mobile_items-number">1.2.4.</span> <span class="toc_mobile_items-text">使用openssl工具构建证书和秘钥</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#创建CA"><span class="toc_mobile_items-number">1.2.4.1.</span> <span class="toc_mobile_items-text">创建CA</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#创建kubernetes证书"><span class="toc_mobile_items-number">1.2.4.2.</span> <span class="toc_mobile_items-text">创建kubernetes证书</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#admin-证书"><span class="toc_mobile_items-number">1.2.4.3.</span> <span class="toc_mobile_items-text">admin 证书</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#创建kube-proxy的证书"><span class="toc_mobile_items-number">1.2.4.4.</span> <span class="toc_mobile_items-text">创建kube-proxy的证书</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#校验证书-1"><span class="toc_mobile_items-number">1.2.4.5.</span> <span class="toc_mobile_items-text">校验证书</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#分发证书-1"><span class="toc_mobile_items-number">1.2.4.6.</span> <span class="toc_mobile_items-text">分发证书</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#搭建高可用etcd集群"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">搭建高可用etcd集群</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#TLS-认证文件"><span class="toc_mobile_items-number">1.3.1.</span> <span class="toc_mobile_items-text">TLS 认证文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#下载二进制文件"><span class="toc_mobile_items-number">1.3.2.</span> <span class="toc_mobile_items-text">下载二进制文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#创建-etcd-的-systemd-unit-文件"><span class="toc_mobile_items-number">1.3.3.</span> <span class="toc_mobile_items-text">创建 etcd 的 systemd unit 文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#启动-etcd-服务"><span class="toc_mobile_items-number">1.3.4.</span> <span class="toc_mobile_items-text">启动 etcd 服务</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#验证服务"><span class="toc_mobile_items-number">1.3.5.</span> <span class="toc_mobile_items-text">验证服务</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#搭建kubernetes-master节点"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">搭建kubernetes master节点</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#配置和启动kube-apiserver"><span class="toc_mobile_items-number">1.4.1.</span> <span class="toc_mobile_items-text">配置和启动kube-apiserver</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#配置和启动-kube-controller-manager"><span class="toc_mobile_items-number">1.4.2.</span> <span class="toc_mobile_items-text">配置和启动 kube-controller-manager</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#启动-kube-controller-manager"><span class="toc_mobile_items-number">1.4.3.</span> <span class="toc_mobile_items-text">启动 kube-controller-manager</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#安装kubectl命令行工具"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">安装kubectl命令行工具</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#创建-kubeconfig-文件"><span class="toc_mobile_items-number">1.6.</span> <span class="toc_mobile_items-text">创建 kubeconfig 文件</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#创建-TLS-Bootstrapping-Token"><span class="toc_mobile_items-number">1.6.1.</span> <span class="toc_mobile_items-text">创建 TLS Bootstrapping Token</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#创建-kubelet-bootstrapping-kubeconfig-文件"><span class="toc_mobile_items-number">1.6.2.</span> <span class="toc_mobile_items-text">创建 kubelet bootstrapping kubeconfig 文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#创建-kube-proxy-kubeconfig-文件"><span class="toc_mobile_items-number">1.6.3.</span> <span class="toc_mobile_items-text">创建 kube-proxy kubeconfig 文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#分发-kubeconfig-文件"><span class="toc_mobile_items-number">1.6.4.</span> <span class="toc_mobile_items-text">分发 kubeconfig 文件</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#部署node节点"><span class="toc_mobile_items-number">1.7.</span> <span class="toc_mobile_items-text">部署node节点</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装和配置-kubelet"><span class="toc_mobile_items-number">1.7.1.</span> <span class="toc_mobile_items-text">安装和配置 kubelet</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#启动kublet"><span class="toc_mobile_items-number">1.7.2.</span> <span class="toc_mobile_items-text">启动kublet</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#通过-kublet-的-TLS-证书请求"><span class="toc_mobile_items-number">1.7.3.</span> <span class="toc_mobile_items-text">通过 kublet 的 TLS 证书请求</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#配置-kube-proxy"><span class="toc_mobile_items-number">1.7.4.</span> <span class="toc_mobile_items-text">配置 kube-proxy</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#启动-kube-proxy"><span class="toc_mobile_items-number">1.7.5.</span> <span class="toc_mobile_items-text">启动 kube-proxy</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#部署calico"><span class="toc_mobile_items-number">1.8.</span> <span class="toc_mobile_items-text">部署calico</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#下载calico相关的docker镜像"><span class="toc_mobile_items-number">1.8.1.</span> <span class="toc_mobile_items-text">下载calico相关的docker镜像</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#构建RBAC"><span class="toc_mobile_items-number">1.8.2.</span> <span class="toc_mobile_items-text">构建RBAC</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装calico"><span class="toc_mobile_items-number">1.8.3.</span> <span class="toc_mobile_items-text">安装calico</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#安装addon组件"><span class="toc_mobile_items-number">1.9.</span> <span class="toc_mobile_items-text">安装addon组件</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装kube-dns"><span class="toc_mobile_items-number">1.9.1.</span> <span class="toc_mobile_items-text">安装kube-dns</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装dashboard"><span class="toc_mobile_items-number">1.9.2.</span> <span class="toc_mobile_items-text">安装dashboard</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装heapster"><span class="toc_mobile_items-number">1.9.3.</span> <span class="toc_mobile_items-text">安装heapster</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装ingress-nginx-Controller"><span class="toc_mobile_items-number">1.9.4.</span> <span class="toc_mobile_items-text">安装ingress-nginx Controller</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#手动安装kubernetes集群"><span class="toc-number">1.</span> <span class="toc-text">手动安装kubernetes集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境准备"><span class="toc-number">1.1.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建TLS证书和秘钥"><span class="toc-number">1.2.</span> <span class="toc-text">创建TLS证书和秘钥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#生成的-CA-证书和秘钥文件如下："><span class="toc-number">1.2.1.</span> <span class="toc-text">生成的 CA 证书和秘钥文件如下：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用证书的组件如下："><span class="toc-number">1.2.2.</span> <span class="toc-text">使用证书的组件如下：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用cfssl工具构建证书"><span class="toc-number">1.2.3.</span> <span class="toc-text">使用cfssl工具构建证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装cfssl工具"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">安装cfssl工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-CA-Certificate-Authority"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">创建 CA (Certificate Authority)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-kubernetes-证书"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">创建 kubernetes 证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-admin-证书"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">创建 admin 证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-kube-proxy-证书"><span class="toc-number">1.2.3.5.</span> <span class="toc-text">创建 kube-proxy 证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#校验证书"><span class="toc-number">1.2.3.6.</span> <span class="toc-text">校验证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分发证书"><span class="toc-number">1.2.3.7.</span> <span class="toc-text">分发证书</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用openssl工具构建证书和秘钥"><span class="toc-number">1.2.4.</span> <span class="toc-text">使用openssl工具构建证书和秘钥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建CA"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">创建CA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建kubernetes证书"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">创建kubernetes证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#admin-证书"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">admin 证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建kube-proxy的证书"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">创建kube-proxy的证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#校验证书-1"><span class="toc-number">1.2.4.5.</span> <span class="toc-text">校验证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分发证书-1"><span class="toc-number">1.2.4.6.</span> <span class="toc-text">分发证书</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#搭建高可用etcd集群"><span class="toc-number">1.3.</span> <span class="toc-text">搭建高可用etcd集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TLS-认证文件"><span class="toc-number">1.3.1.</span> <span class="toc-text">TLS 认证文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载二进制文件"><span class="toc-number">1.3.2.</span> <span class="toc-text">下载二进制文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-etcd-的-systemd-unit-文件"><span class="toc-number">1.3.3.</span> <span class="toc-text">创建 etcd 的 systemd unit 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-etcd-服务"><span class="toc-number">1.3.4.</span> <span class="toc-text">启动 etcd 服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证服务"><span class="toc-number">1.3.5.</span> <span class="toc-text">验证服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#搭建kubernetes-master节点"><span class="toc-number">1.4.</span> <span class="toc-text">搭建kubernetes master节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置和启动kube-apiserver"><span class="toc-number">1.4.1.</span> <span class="toc-text">配置和启动kube-apiserver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置和启动-kube-controller-manager"><span class="toc-number">1.4.2.</span> <span class="toc-text">配置和启动 kube-controller-manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-kube-controller-manager"><span class="toc-number">1.4.3.</span> <span class="toc-text">启动 kube-controller-manager</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装kubectl命令行工具"><span class="toc-number">1.5.</span> <span class="toc-text">安装kubectl命令行工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建-kubeconfig-文件"><span class="toc-number">1.6.</span> <span class="toc-text">创建 kubeconfig 文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-TLS-Bootstrapping-Token"><span class="toc-number">1.6.1.</span> <span class="toc-text">创建 TLS Bootstrapping Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-kubelet-bootstrapping-kubeconfig-文件"><span class="toc-number">1.6.2.</span> <span class="toc-text">创建 kubelet bootstrapping kubeconfig 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-kube-proxy-kubeconfig-文件"><span class="toc-number">1.6.3.</span> <span class="toc-text">创建 kube-proxy kubeconfig 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分发-kubeconfig-文件"><span class="toc-number">1.6.4.</span> <span class="toc-text">分发 kubeconfig 文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署node节点"><span class="toc-number">1.7.</span> <span class="toc-text">部署node节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装和配置-kubelet"><span class="toc-number">1.7.1.</span> <span class="toc-text">安装和配置 kubelet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动kublet"><span class="toc-number">1.7.2.</span> <span class="toc-text">启动kublet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过-kublet-的-TLS-证书请求"><span class="toc-number">1.7.3.</span> <span class="toc-text">通过 kublet 的 TLS 证书请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-kube-proxy"><span class="toc-number">1.7.4.</span> <span class="toc-text">配置 kube-proxy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-kube-proxy"><span class="toc-number">1.7.5.</span> <span class="toc-text">启动 kube-proxy</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署calico"><span class="toc-number">1.8.</span> <span class="toc-text">部署calico</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载calico相关的docker镜像"><span class="toc-number">1.8.1.</span> <span class="toc-text">下载calico相关的docker镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#构建RBAC"><span class="toc-number">1.8.2.</span> <span class="toc-text">构建RBAC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装calico"><span class="toc-number">1.8.3.</span> <span class="toc-text">安装calico</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装addon组件"><span class="toc-number">1.9.</span> <span class="toc-text">安装addon组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装kube-dns"><span class="toc-number">1.9.1.</span> <span class="toc-text">安装kube-dns</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装dashboard"><span class="toc-number">1.9.2.</span> <span class="toc-text">安装dashboard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装heapster"><span class="toc-number">1.9.3.</span> <span class="toc-text">安装heapster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装ingress-nginx-Controller"><span class="toc-number">1.9.4.</span> <span class="toc-text">安装ingress-nginx Controller</span></a></li></ol></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.pixabay.com/photo/2017/01/15/22/38/in-winter-forest-1982920_1280.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">手动安装kubernetes</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2018-01-24<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2018-03-05</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="手动安装kubernetes集群"><a href="#手动安装kubernetes集群" class="headerlink" title="手动安装kubernetes集群"></a>手动安装kubernetes集群</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ol>
<li>准备4个centos7系统的虚机，搭建HA环境的kubernetes集群<br> master: 172.168.0.25, 172.168.0.26, 172.168.0.27<br> node: 172.168.0.28</li>
<li>虚机之前做免秘钥认证，方便访问<ul>
<li>ssh-keygen生成ssh的公钥和私钥</li>
<li>ssh-copy-id 拷贝公钥至各个节点</li>
</ul>
</li>
<li>修改各个节点的/etc/hosts文件<blockquote>
<p>172.168.0.25 qinweiwei-1<br>172.168.0.26 qinweiwei-2<br>172.168.0.27 qinweiwei-3<br>172.168.0.28 qinweiwei-4</p>
</blockquote>
</li>
<li>安装ansible，方便直接在各个节点执行命令<ul>
<li>yum install ansible</li>
<li>ansible all -m shell -a “command”</li>
</ul>
</li>
<li>安装docker,执行以下命令：ansible all -m command -a “yum install docker -y”<blockquote>
<p>CentOS-Base.repo文件使用<code>mirrorlist</code>,不要用<code>baseurl</code><br>mirrorlist=<a href="http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=os&amp;infra=$infra" target="_blank" rel="noopener">http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=os&amp;infra=$infra</a><br>#baseurl=<a href="http://mirror.centos.org/centos/$releasever/os/$basearch/" target="_blank" rel="noopener">http://mirror.centos.org/centos/$releasever/os/$basearch/</a></p>
</blockquote>
</li>
<li>关闭所有节点的SELinux,使用命令 setenforce 0<h2 id="创建TLS证书和秘钥"><a href="#创建TLS证书和秘钥" class="headerlink" title="创建TLS证书和秘钥"></a>创建TLS证书和秘钥</h2><a id="more"></a>
kubernetes 系统的各组件需要使用 TLS 证书对通信进行加密, 下边依次介绍使用<code>cfssl</code>和<code>openssl</code>工具构建CA和其他证书<h3 id="生成的-CA-证书和秘钥文件如下："><a href="#生成的-CA-证书和秘钥文件如下：" class="headerlink" title="生成的 CA 证书和秘钥文件如下："></a>生成的 CA 证书和秘钥文件如下：</h3></li>
</ol>
<ul>
<li>ca-key.pem</li>
<li>ca.pem</li>
<li>kubernetes-key.pem</li>
<li>kubernetes.pem</li>
<li>kube-proxy.pem</li>
<li>kube-proxy-key.pem</li>
<li>admin.pem</li>
<li>admin-key.pem<h3 id="使用证书的组件如下："><a href="#使用证书的组件如下：" class="headerlink" title="使用证书的组件如下："></a>使用证书的组件如下：</h3></li>
<li>etcd：使用 ca.pem、kubernetes-key.pem、kubernetes.pem</li>
<li>kube-apiserver：使用 ca.pem、kubernetes-key.pem、kubernetes.pem</li>
<li>kubelet：使用 ca.pem</li>
<li>kube-proxy：使用 ca.pem、kube-proxy-key.pem、kube-proxy.pem</li>
<li>kubectl：使用 ca.pem、admin-key.pem、admin.pem<h3 id="使用cfssl工具构建证书"><a href="#使用cfssl工具构建证书" class="headerlink" title="使用cfssl工具构建证书"></a>使用cfssl工具构建证书</h3><h4 id="安装cfssl工具"><a href="#安装cfssl工具" class="headerlink" title="安装cfssl工具"></a>安装cfssl工具</h4></li>
</ul>
<ol>
<li>go get -u github.com/cloudflare/cfssl/cmd/…</li>
<li>cp $GOPATH/bin/cfssl* /usr/bin/<h4 id="创建-CA-Certificate-Authority"><a href="#创建-CA-Certificate-Authority" class="headerlink" title="创建 CA (Certificate Authority)"></a>创建 CA (Certificate Authority)</h4>创建 CA 配置文件</li>
</ol>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;root&#x2F;ssl</span><br><span class="line">cd &#x2F;root&#x2F;ssl</span><br><span class="line">cfssl print-defaults config &gt; config.json</span><br><span class="line">cfssl print-defaults csr &gt; csr.json</span><br><span class="line"># 根据config.json文件的格式创建如下的ca-config.json文件</span><br><span class="line"># 过期时间设置成了 87600h</span><br><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></div>

<p>字段说明:</p>
<ul>
<li>ca-config.json：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile</li>
<li>signing：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE</li>
<li>server auth：表示client可以用该 CA 对server提供的证书进行验证</li>
<li>client auth：表示server可以用该CA对client提供的证书进行验证<br>创建 CA 证书签名请求<br>创建 ca-csr.json 文件，内容如下：</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>“CN”：Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法</li>
<li>“O”：Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)<br>生成 CA 证书和私钥:</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line">$ ls ca*</span><br><span class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</span><br></pre></td></tr></table></figure></div>

<h4 id="创建-kubernetes-证书"><a href="#创建-kubernetes-证书" class="headerlink" title="创建 kubernetes 证书"></a>创建 kubernetes 证书</h4><p>创建 kubernetes 证书签名请求</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ cat kubernetes-csr.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">      &quot;127.0.0.1&quot;,</span><br><span class="line">      &quot;172.20.0.112&quot;,</span><br><span class="line">      &quot;172.20.0.113&quot;,</span><br><span class="line">      &quot;172.20.0.114&quot;,</span><br><span class="line">      &quot;172.20.0.115&quot;,</span><br><span class="line">      &quot;10.254.0.1&quot;,</span><br><span class="line">      &quot;kubernetes&quot;,</span><br><span class="line">      &quot;kubernetes.default&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">      &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>如果 hosts 字段不为空则需要指定授权使用该证书的 IP 或域名列表，由于该证书后续被 etcd 集群和 kubernetes master 集群使用，所以上面分别指定了 etcd 集群、kubernetes master 集群的主机 IP 和 kubernetes 服务的服务 IP（一般是 kue-apiserver 指定的 service-cluster-ip-range 网段的第一个IP，如 10.254.0.1。<br>生成 kubernetes 证书和私钥</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span><br><span class="line">$ ls kubernetes*</span><br><span class="line">kubernetes.csr  kubernetes-csr.json  kubernetes-key.pem  kubernetes.pem</span><br></pre></td></tr></table></figure></div>

<p>或者直接在命令行上指定相关参数</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#39;&#123;&quot;CN&quot;:&quot;kubernetes&quot;,&quot;hosts&quot;:[&quot;&quot;],&quot;key&quot;:&#123;&quot;algo&quot;:&quot;rsa&quot;,&quot;size&quot;:2048&#125;&#125;&#39; | cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;kubernetes -hostname&#x3D;&quot;127.0.0.1,172.20.0.112,172.20.0.113,172.20.0.114,172.20.0.115,kubernetes,kubernetes.default&quot; - | cfssljson -bare kubernetes</span><br></pre></td></tr></table></figure></div>

<h4 id="创建-admin-证书"><a href="#创建-admin-证书" class="headerlink" title="创建 admin 证书"></a>创建 admin 证书</h4><p>创建 admin 证书签名请求</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ cat admin-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;admin&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>后续 kube-apiserver 使用 RBAC 对客户端(如 kubelet、kube-proxy、Pod)请求进行授权</li>
<li>kube-apiserver 预定义了一些 RBAC 使用的 RoleBindings，如 cluster-admin 将 Group system:masters 与 Role cluster-admin 绑定，该 Role 授予了调用kube-apiserver 的所有 API的权限</li>
<li>OU 指定该证书的 Group 为 system:masters，kubelet 使用该证书访问 kube-apiserver 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 system:masters，所以被授予访问所有 API 的权限</li>
</ul>
<p>生成 admin 证书和私钥</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line">$ ls admin*</span><br><span class="line">admin.csr  admin-csr.json  admin-key.pem  admin.pem</span><br></pre></td></tr></table></figure></div>
<h4 id="创建-kube-proxy-证书"><a href="#创建-kube-proxy-证书" class="headerlink" title="创建 kube-proxy 证书"></a>创建 kube-proxy 证书</h4><p>创建 kube-proxy 证书签名请求</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ cat kube-proxy-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>CN 指定该证书的 User 为 system:kube-proxy</li>
<li>kube-apiserver 预定义的 RoleBinding cluster-admin 将User system:kube-proxy 与 Role system:node-proxier 绑定，该 Role 授予了调用 kube-apiserver Proxy 相关 API 的权限<br>生成 kube-proxy 客户端证书和私钥</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert -ca&#x3D;ca.pem -ca-key&#x3D;ca-key.pem -config&#x3D;ca-config.json -profile&#x3D;kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">$ ls kube-proxy*</span><br><span class="line">kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem</span><br></pre></td></tr></table></figure></div>

<h4 id="校验证书"><a href="#校验证书" class="headerlink" title="校验证书"></a>校验证书</h4><p>以 kubernetes 证书为例</p>
<ul>
<li>cfssl-certinfo -cert kubernetes.pem</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;subject&quot;: &#123;</span><br><span class="line">    &quot;common_name&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;country&quot;: &quot;CN&quot;,</span><br><span class="line">    &quot;organization&quot;: &quot;k8s&quot;,</span><br><span class="line">    &quot;organizational_unit&quot;: &quot;System&quot;,</span><br><span class="line">    &quot;locality&quot;: &quot;BeiJing&quot;,</span><br><span class="line">    &quot;province&quot;: &quot;BeiJing&quot;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">      &quot;CN&quot;,</span><br><span class="line">      &quot;BeiJing&quot;,</span><br><span class="line">      &quot;BeiJing&quot;,</span><br><span class="line">      &quot;k8s&quot;,</span><br><span class="line">      &quot;System&quot;,</span><br><span class="line">      &quot;kubernetes&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;issuer&quot;: &#123;</span><br><span class="line">    &quot;common_name&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;country&quot;: &quot;CN&quot;,</span><br><span class="line">    &quot;organization&quot;: &quot;k8s&quot;,</span><br><span class="line">    &quot;organizational_unit&quot;: &quot;System&quot;,</span><br><span class="line">    &quot;locality&quot;: &quot;BeiJing&quot;,</span><br><span class="line">    &quot;province&quot;: &quot;BeiJing&quot;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">      &quot;CN&quot;,</span><br><span class="line">      &quot;BeiJing&quot;,</span><br><span class="line">      &quot;BeiJing&quot;,</span><br><span class="line">      &quot;k8s&quot;,</span><br><span class="line">      &quot;System&quot;,</span><br><span class="line">      &quot;kubernetes&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;serial_number&quot;: &quot;342576193900195567380707167251794624995944458399&quot;,</span><br><span class="line">  &quot;sans&quot;: [</span><br><span class="line">    &quot;qinweiwei-1&quot;,</span><br><span class="line">    &quot;qinweiwei-2&quot;,</span><br><span class="line">    &quot;qinweiwei-3&quot;,</span><br><span class="line">    &quot;qinweiwei-4&quot;,</span><br><span class="line">    &quot;kubernetes&quot;,</span><br><span class="line">    &quot;kubernetes.default&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">    &quot;kubernetes.default.svc.cluster.local&quot;,</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;172.168.0.25&quot;,</span><br><span class="line">    &quot;172.168.0.26&quot;,</span><br><span class="line">    &quot;172.168.0.27&quot;,</span><br><span class="line">    &quot;172.168.0.28&quot;,</span><br><span class="line">    &quot;10.254.0.1&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;not_before&quot;: &quot;2018-01-28T12:38:00Z&quot;,</span><br><span class="line">  &quot;not_after&quot;: &quot;2028-01-26T12:38:00Z&quot;,</span><br><span class="line">  &quot;sigalg&quot;: &quot;SHA256WithRSA&quot;,</span><br><span class="line">  &quot;authority_key_id&quot;: &quot;&quot;,</span><br><span class="line">  &quot;subject_key_id&quot;:</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>确认 Issuer 字段的内容和 ca-csr.json 一致</li>
<li>确认 Subject 字段的内容和 kubernetes-csr.json 一致</li>
<li>确认 X509v3 Subject Alternative Name 字段的内容和 kubernetes-csr.json 一致</li>
<li>确认 X509v3 Key Usage、Extended Key Usage 字段的内容和 ca-config.json 中 kubernetes profile 一致</li>
</ul>
<h4 id="分发证书"><a href="#分发证书" class="headerlink" title="分发证书"></a>分发证书</h4><p>将生成的证书和秘钥文件（后缀名为.pem）拷贝到所有机器的 /etc/kubernetes/ssl 目录下备用</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p &#x2F;etc&#x2F;kubernetes&#x2F;ssl</span><br><span class="line">$ sudo cp *.pem &#x2F;etc&#x2F;kubernetes&#x2F;ssl</span><br></pre></td></tr></table></figure></div>

<h3 id="使用openssl工具构建证书和秘钥"><a href="#使用openssl工具构建证书和秘钥" class="headerlink" title="使用openssl工具构建证书和秘钥"></a>使用openssl工具构建证书和秘钥</h3><h4 id="创建CA"><a href="#创建CA" class="headerlink" title="创建CA"></a>创建CA</h4><ul>
<li>openssl genrsa -out ca-key.pem 2048</li>
<li>openssl req -x509 -new -nodes -key ca-key.pem -days 10000 -out ca.pem -subj “/CN=kubernetes”<h4 id="创建kubernetes证书"><a href="#创建kubernetes证书" class="headerlink" title="创建kubernetes证书"></a>创建kubernetes证书</h4></li>
<li>cp /etc/pki/tls/openssl.cnf .</li>
<li>vim openssl.cnf</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[req]</span><br><span class="line">req_extensions &#x3D; v3_req # 这行默认注释关着的 把注释删掉# 下面配置是新增的</span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstraints &#x3D; CA:FALSE</span><br><span class="line">keyUsage &#x3D; nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line">subjectAltName &#x3D; @alt_names</span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 &#x3D; qinweiwei-1</span><br><span class="line">DNS.2 &#x3D; qinweiwei-2</span><br><span class="line">DNS.3 &#x3D; qinweiwei-3</span><br><span class="line">DNS.4 &#x3D; qinweiwei-4</span><br><span class="line">DNS.5 &#x3D; kubernetes</span><br><span class="line">DNS.6 &#x3D; kubernetes.default</span><br><span class="line">DNS.7 &#x3D; kubernetes.default.svc</span><br><span class="line">DNS.8 &#x3D; kubernetes.default.svc.cluster</span><br><span class="line">DNS.9 &#x3D; kubernetes.default.svc.cluster.local</span><br><span class="line">IP.1 &#x3D; 127.0.0.1</span><br><span class="line">IP.2 &#x3D; 172.168.0.25</span><br><span class="line">IP.3 &#x3D; 172.168.0.26</span><br><span class="line">IP.4 &#x3D; 172.168.0.27</span><br><span class="line">IP.5 &#x3D; 172.168.0.28</span><br><span class="line">IP.6 &#x3D; 10.254.0.1</span><br></pre></td></tr></table></figure></div>

<ul>
<li>openssl genrsa -out kubernetes-key.pem 2048</li>
<li>openssl req -new -key kubernetes-key.pem -out kubernetes.csr -subj “/C=CN/ST=beijing/L=beijing/O=k8s/OU=system/CN=kubernetes/“ -config openssl.cnf</li>
<li>openssl x509 -req -in kubernetes.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out kubernetes.pem -days 365 -extensions v3_req -extfile openssl.cnf<h4 id="admin-证书"><a href="#admin-证书" class="headerlink" title="admin 证书"></a>admin 证书</h4></li>
<li>cp /etc/pki/tls/openssl.cnf .</li>
<li>vim openssl.cnf</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[req]</span><br><span class="line">req_extensions &#x3D; v3_req # 这行默认注释关着的 把注释删掉# 下面配置是新增的</span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstraints &#x3D; CA:FALSE</span><br><span class="line">keyUsage &#x3D; nonRepudiation, digitalSignature, keyEncipherment</span><br></pre></td></tr></table></figure></div>

<ul>
<li>openssl genrsa -out admin-key.pem 2048</li>
<li>openssl req -new -key admin-key.pem -out admin.csr -subj “/C=CN/ST=beijing/L=beijing/O=system:masters/OU=system/CN=admin/“ -config openssl.cnf</li>
<li>openssl x509 -req -in admin.csr -CA ca.pem -CAkey ca-key.pem -CAcreateserial -out admin.pem -days 365 -extensions v3_req -extfile openssl.cnf<h4 id="创建kube-proxy的证书"><a href="#创建kube-proxy的证书" class="headerlink" title="创建kube-proxy的证书"></a>创建kube-proxy的证书</h4>同admin证书一样，只是-subj “/CN=system:kube-proxy”<h4 id="校验证书-1"><a href="#校验证书-1" class="headerlink" title="校验证书"></a>校验证书</h4>以 kubernetes 证书为例</li>
<li>openssl x509  -noout -text -in  kubernetes.pem</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            8b:21:12:8d:52:e2:0e:60</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: CN&#x3D;kubernetes</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Jan 28 14:23:58 2018 GMT</span><br><span class="line">            Not After : Jan 28 14:23:58 2019 GMT</span><br><span class="line">        Subject: C&#x3D;CN, ST&#x3D;beijing, L&#x3D;beijing, O&#x3D;k8s, OU&#x3D;system, CN&#x3D;kubernetes</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:a8:07:b3:42:ef:be:b3:15:92:35:4d:ab:5e:92:</span><br><span class="line">                    c9:34:cb:97:49:41:11:b4:6f:87:0f:b6:8b:2a:e4:</span><br><span class="line">                    c0:ac:b3:a3:f2:51:5e:0b:7f:fb:2f:85:d6:56:a2:</span><br><span class="line">                    a5:65:91:79:9f:06:84:c4:4b:a7:2d:21:a4:e9:96:</span><br><span class="line">                    07:87:31:80:4b:63:2d:c9:9b:88:aa:77:85:96:7d:</span><br><span class="line">                    8f:b0:39:d0:ea:8c:ab:9c:af:17:5d:d9:68:65:0b:</span><br><span class="line">                    c1:b3:27:f2:92:94:70:fe:b6:27:8c:26:95:6a:bc:</span><br><span class="line">                    b2:80:22:c8:e9:1d:79:10:7f:07:88:c0:d8:8b:31:</span><br><span class="line">                    15:99:7d:33:e0:ac:62:8c:04:b6:ce:e5:f8:aa:37:</span><br><span class="line">                    53:20:e2:38:ef:bc:1f:4c:66:5c:47:99:c1:d7:8c:</span><br><span class="line">                    03:44:5b:22:36:bc:c5:55:8c:5b:a9:4d:ab:3a:9f:</span><br><span class="line">                    fa:09:3f:35:57:23:c7:05:e5:c7:c8:e8:23:5c:2f:</span><br><span class="line">                    e2:12:f4:fc:65:79:a0:4f:56:91:47:6b:7b:0b:82:</span><br><span class="line">                    56:ae:e3:c9:10:77:0b:ad:33:20:14:1f:b0:25:2e:</span><br><span class="line">                    76:aa:e6:51:4c:8d:ad:3f:9b:73:ae:32:8b:f0:76:</span><br><span class="line">                    3d:1d:48:02:76:23:e2:d2:27:69:94:9a:14:de:20:</span><br><span class="line">                    c2:33:ed:21:41:16:ef:69:64:82:a5:f7:6d:56:48:</span><br><span class="line">                    2c:71</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints:</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Key Usage:</span><br><span class="line">                Digital Signature, Non Repudiation, Key Encipherment</span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:qinweiwei-1, DNS:qinweiwei-2, DNS:qinweiwei-3, DNS:qinweiwei-4, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster, DNS:kubernetes.default.svc.cluster.local, IP Address:127.0.0.1, IP Address:172.168.0.25, IP Address:172.168.0.26, IP Address:172.168.0.27, IP Address:172.168.0.28, IP Address:10.254.0.1</span><br><span class="line">                ......</span><br></pre></td></tr></table></figure></div>

<h4 id="分发证书-1"><a href="#分发证书-1" class="headerlink" title="分发证书"></a>分发证书</h4><p>将生成的证书和秘钥文件（后缀名为.pem）拷贝到所有机器的 /etc/kubernetes/ssl 目录下备用</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p &#x2F;etc&#x2F;kubernetes&#x2F;ssl</span><br><span class="line">$ sudo cp *.pem &#x2F;etc&#x2F;kubernetes&#x2F;ssl</span><br></pre></td></tr></table></figure></div>

<h2 id="搭建高可用etcd集群"><a href="#搭建高可用etcd集群" class="headerlink" title="搭建高可用etcd集群"></a>搭建高可用etcd集群</h2><h3 id="TLS-认证文件"><a href="#TLS-认证文件" class="headerlink" title="TLS 认证文件"></a>TLS 认证文件</h3><p>需要为 etcd 集群创建加密通信的 TLS 证书，这里复用以前创建的 kubernetes 证书</p>
<blockquote>
<p>$ cp ca.pem kubernetes-key.pem kubernetes.pem /etc/kubernetes/ssl</p>
</blockquote>
<ul>
<li>kubernetes 证书的 hosts 字段列表中包含上面三台机器的 IP，否则后续证书校验会失败</li>
</ul>
<h3 id="下载二进制文件"><a href="#下载二进制文件" class="headerlink" title="下载二进制文件"></a>下载二进制文件</h3><p>到 <a href="https://github.com/coreos/etcd/releases" target="_blank" rel="noopener">https://github.com/coreos/etcd/releases</a> 页面下载最新版本的二进制文件</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ https:&#x2F;&#x2F;github.com&#x2F;coreos&#x2F;etcd&#x2F;releases&#x2F;download&#x2F;v3.1.5&#x2F;etcd-v3.1.5-linux-amd64.tar.gz</span><br><span class="line">$ tar -xvf etcd-v3.1.5-linux-amd64.tar.gz</span><br><span class="line">$ sudo mv etcd-v3.1.5-linux-amd64&#x2F;etcd* &#x2F;usr&#x2F;bin</span><br></pre></td></tr></table></figure></div>

<h3 id="创建-etcd-的-systemd-unit-文件"><a href="#创建-etcd-的-systemd-unit-文件" class="headerlink" title="创建 etcd 的 systemd unit 文件"></a>创建 etcd 的 systemd unit 文件</h3><p>注意替换IP地址为你自己的etcd集群的主机IP。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Etcd Server</span><br><span class="line">After&#x3D;network.target</span><br><span class="line">After&#x3D;network-online.target</span><br><span class="line">Wants&#x3D;network-online.target</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;github.com&#x2F;coreos</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;notify</span><br><span class="line">WorkingDirectory&#x3D;&#x2F;var&#x2F;lib&#x2F;etcd&#x2F;</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;etcd&#x2F;etcd.conf</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;etcd \</span><br><span class="line">  --name $&#123;ETCD_NAME&#125; \</span><br><span class="line">  --cert-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubernetes.pem \</span><br><span class="line">  --key-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubernetes-key.pem \</span><br><span class="line">  --peer-cert-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubernetes.pem \</span><br><span class="line">  --peer-key-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubernetes-key.pem \</span><br><span class="line">  --trusted-ca-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem \</span><br><span class="line">  --peer-trusted-ca-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem \</span><br><span class="line">  --initial-advertise-peer-urls $&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \</span><br><span class="line">  --listen-peer-urls $&#123;ETCD_LISTEN_PEER_URLS&#125; \</span><br><span class="line">  --listen-client-urls $&#123;ETCD_LISTEN_CLIENT_URLS&#125;,https:&#x2F;&#x2F;127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls $&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \</span><br><span class="line">  --initial-cluster-token $&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125; \</span><br><span class="line">  --initial-cluster qinweiwei-1&#x3D;https:&#x2F;&#x2F;172.168.0.25:2380,qinweiwei-2&#x3D;https:&#x2F;&#x2F;172.168.0.27:2380,qinweiwei-3&#x3D;https:&#x2F;&#x2F;172.168.0.28:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir&#x3D;$&#123;ETCD_DATA_DIR&#125;</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">RestartSec&#x3D;5</span><br><span class="line">LimitNOFILE&#x3D;65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure></div>

<ul>
<li>指定 etcd 的工作目录为 /var/lib/etcd，数据目录为 /var/lib/etcd，需在启动服务前创建这两个目录，否则etcd进程启动失败。</li>
<li>为了保证通信安全，需要指定 etcd 的公私钥(cert-file和key-file)、Peers 通信的公私钥和 CA 证书(peer-cert-file、peer-key-file、peer-trusted-ca-file)、客户端的CA证书（trusted-ca-file）</li>
<li>创建 kubernetes.pem 证书时使用的 kubernetes-csr.json 文件的 hosts 字段包含所有 etcd 节点的IP，否则证书校验会出错</li>
<li>–initial-cluster-state 值为 new 时，–name 的参数值必须位于 –initial-cluster 列表中</li>
</ul>
<p>环境变量配置文件/etc/etcd/etcd.conf。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># [member]</span><br><span class="line">ETCD_NAME&#x3D;qinweiwei-1</span><br><span class="line">ETCD_DATA_DIR&#x3D;&quot;&#x2F;var&#x2F;lib&#x2F;etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS&#x3D;&quot;https:&#x2F;&#x2F;172.168.0.25:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS&#x3D;&quot;https:&#x2F;&#x2F;172.168.0.25:2379&quot;</span><br><span class="line"></span><br><span class="line">#[cluster]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS&#x3D;&quot;https:&#x2F;&#x2F;172.168.0.25:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN&#x3D;&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS&#x3D;&quot;https:&#x2F;&#x2F;172.168.0.25:2379&quot;</span><br></pre></td></tr></table></figure></div>

<p>其他两个etcd节点只要将上面的IP地址改成相应节点的IP地址即可</p>
<h3 id="启动-etcd-服务"><a href="#启动-etcd-服务" class="headerlink" title="启动 etcd 服务"></a>启动 etcd 服务</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mv etcd.service &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;</span><br><span class="line">$ sudo systemctl daemon-reload</span><br><span class="line">$ sudo systemctl enable etcd</span><br><span class="line">$ sudo systemctl start etcd</span><br><span class="line">$ systemctl status etcd</span><br></pre></td></tr></table></figure></div>

<h3 id="验证服务"><a href="#验证服务" class="headerlink" title="验证服务"></a>验证服务</h3><p>在任一 kubernetes master 机器上执行如下命令</p>
<blockquote>
<p>etcdctl –ca-file=/etc/kubernetes/ssl/ca.pem –cert-file=/etc/kubernetes/ssl/kubernetes.pem –key-file=/etc/kubernetes/ssl/kubernetes-key.pem –endpoints <a href="https://172.168.0.27:2379" target="_blank" rel="noopener">https://172.168.0.27:2379</a> cluster-health</p>
</blockquote>
<p>结果最后一行为 cluster is healthy 时表示集群服务正常。</p>
<h2 id="搭建kubernetes-master节点"><a href="#搭建kubernetes-master节点" class="headerlink" title="搭建kubernetes master节点"></a>搭建kubernetes master节点</h2><p>下载kube-apiserver，kube-scheduler，kube-controller-manage，kubelet，kube-proxy的二进制文件，并拷贝至PATH路径下</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https:&#x2F;&#x2F;dl.k8s.io&#x2F;v1.7.0&#x2F;kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">$ tar -xzvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">$ cp -r server&#x2F;bin&#x2F;&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet&#125; &#x2F;usr&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure></div>

<h3 id="配置和启动kube-apiserver"><a href="#配置和启动kube-apiserver" class="headerlink" title="配置和启动kube-apiserver"></a>配置和启动kube-apiserver</h3><p>serivce配置文件/usr/lib/systemd/system/kube-apiserver.service内容：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Kubernetes API Service</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;github.com&#x2F;GoogleCloudPlatform&#x2F;kubernetes</span><br><span class="line">After&#x3D;network.target</span><br><span class="line">After&#x3D;etcd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;kubernetes&#x2F;config</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;kubernetes&#x2F;apiserver</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;kube-apiserver \</span><br><span class="line">      $KUBE_LOGTOSTDERR \</span><br><span class="line">      $KUBE_LOG_DIR \</span><br><span class="line">      $KUBE_LOG_LEVEL \</span><br><span class="line">      $KUBE_ETCD_SERVERS \</span><br><span class="line">      $KUBE_API_ADDRESS \</span><br><span class="line">      $KUBE_API_PORT \</span><br><span class="line">      $KUBELET_PORT \</span><br><span class="line">      $KUBE_ALLOW_PRIV \</span><br><span class="line">      $KUBE_SERVICE_ADDRESSES \</span><br><span class="line">      $KUBE_ADMISSION_CONTROL \</span><br><span class="line">      $KUBE_API_ARGS</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">Type&#x3D;notify</span><br><span class="line">LimitNOFILE&#x3D;65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure></div>

<p>/etc/kubernetes/config文件的内容为:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">###</span><br><span class="line"># kubernetes system config</span><br><span class="line">#</span><br><span class="line"># The following values are used to configure various aspects of all</span><br><span class="line"># kubernetes services, including</span><br><span class="line">#</span><br><span class="line">#   kube-apiserver.service</span><br><span class="line">#   kube-controller-manager.service</span><br><span class="line">#   kube-scheduler.service</span><br><span class="line">#   kubelet.service</span><br><span class="line">#   kube-proxy.service</span><br><span class="line"># logging to stderr means we get it in the systemd journal</span><br><span class="line">KUBE_LOG_DIR&#x3D;&quot;--log-dir&#x3D;&#x2F;var&#x2F;log&#x2F;kubernetes&#x2F;&quot;</span><br><span class="line">KUBE_LOGTOSTDERR&#x3D;&quot;--logtostderr&#x3D;false&quot;</span><br><span class="line"></span><br><span class="line"># journal message level, 0 is debug</span><br><span class="line">KUBE_LOG_LEVEL&#x3D;&quot;--v&#x3D;4&quot;</span><br><span class="line"></span><br><span class="line"># Should this cluster be allowed to run privileged docker containers</span><br><span class="line">KUBE_ALLOW_PRIV&#x3D;&quot;--allow-privileged&#x3D;true&quot;</span><br><span class="line"></span><br><span class="line"># How the controller-manager, scheduler, and proxy find the apiserver</span><br><span class="line">#KUBE_MASTER&#x3D;&quot;--master&#x3D;http:&#x2F;&#x2F;sz-pg-oam-docker-test-001.tendcloud.com:8080&quot;</span><br><span class="line">KUBE_MASTER&#x3D;&quot;--master&#x3D;http:&#x2F;&#x2F;172.168.0.25:8080&quot;</span><br></pre></td></tr></table></figure></div>

<p>该配置文件同时被kube-apiserver、kube-controller-manager、kube-scheduler、kubelet、kube-proxy使用。</p>
<p>apiserver配置文件/etc/kubernetes/apiserver内容为:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">###</span><br><span class="line">## kubernetes system config</span><br><span class="line">##</span><br><span class="line">## The following values are used to configure the kube-apiserver</span><br><span class="line">##</span><br><span class="line">#</span><br><span class="line">## The address on the local server to listen to.</span><br><span class="line">#KUBE_API_ADDRESS&#x3D;&quot;--insecure-bind-address&#x3D;sz-pg-oam-docker-test-001.tendcloud.com&quot;</span><br><span class="line">KUBE_API_ADDRESS&#x3D;&quot;--advertise-address&#x3D;172.168.0.25 --bind-address&#x3D;172.168.0.25 --insecure-bind-address&#x3D;172.168.0.25&quot;</span><br><span class="line">#</span><br><span class="line">## The port on the local server to listen on.</span><br><span class="line">#KUBE_API_PORT&#x3D;&quot;--port&#x3D;8080&quot;</span><br><span class="line">#</span><br><span class="line">## Port minions listen on</span><br><span class="line">#KUBELET_PORT&#x3D;&quot;--kubelet-port&#x3D;10250&quot;</span><br><span class="line">#</span><br><span class="line">## Comma separated list of nodes in the etcd cluster</span><br><span class="line">KUBE_ETCD_SERVERS&#x3D;&quot;--etcd-servers&#x3D;https:&#x2F;&#x2F;172.168.0.25:2379,https:&#x2F;&#x2F;172.168.0.27:2379,https:&#x2F;&#x2F;172.168.0.28:2379&quot;</span><br><span class="line">#</span><br><span class="line">## Address range to use for services</span><br><span class="line">KUBE_SERVICE_ADDRESSES&#x3D;&quot;--service-cluster-ip-range&#x3D;10.254.0.0&#x2F;16&quot;</span><br><span class="line">#</span><br><span class="line">## default admission control policies</span><br><span class="line">KUBE_ADMISSION_CONTROL&#x3D;&quot;--admission-control&#x3D;ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota&quot;</span><br><span class="line">#</span><br><span class="line">## Add your own!</span><br><span class="line">KUBE_API_ARGS&#x3D;&quot;--authorization-mode&#x3D;RBAC --runtime-config&#x3D;rbac.authorization.k8s.io&#x2F;v1beta1 --kubelet-https&#x3D;true --experimental-bootstrap-token-auth --token-auth-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;token.csv --service-node-port-range&#x3D;30000-32767 --tls-cert-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubernetes.pem --tls-private-key-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubernetes-key.pem --client-ca-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem --service-account-key-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca-key.pem --etcd-cafile&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem --etcd-certfile&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubernetes.pem --etcd-keyfile&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubernetes-key.pem --enable-swagger-ui&#x3D;true --apiserver-count&#x3D;3 --audit-log-maxage&#x3D;30 --audit-log-maxbackup&#x3D;3 --audit-log-maxsize&#x3D;100 --audit-log-path&#x3D;&#x2F;var&#x2F;lib&#x2F;audit.log --event-ttl&#x3D;1h&quot;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>–authorization-mode=RBAC 指定在安全端口使用 RBAC 授权模式，拒绝未通过授权的请求；</li>
<li>kube-scheduler、kube-controller-manager 一般和 kube-apiserver 部署在同一台机器上，它们使用非安全端口和 kube-apiserver通信;</li>
<li>kubelet、kube-proxy、kubectl 部署在其它 Node 节点上，如果通过安全端口访问 kube-apiserver，则必须先通过 TLS 证书认证，再通过 RBAC 授权；</li>
<li>kube-proxy、kubectl 通过在使用的证书里指定相关的 User、Group 来达到通过 RBAC 授权的目的；</li>
<li>缺省情况下 kubernetes 对象保存在 etcd /registry 路径下，可以通过 –etcd-prefix 参数进行调整；</li>
<li>runtime-config配置为rbac.authorization.k8s.io/v1beta1，表示运行时的apiVersion；<br>启动apiserver</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl enable kube-apiserver</span><br><span class="line">$ systemctl start kube-apiserver</span><br><span class="line">$ systemctl status kube-apiserver</span><br></pre></td></tr></table></figure></div>

<h3 id="配置和启动-kube-controller-manager"><a href="#配置和启动-kube-controller-manager" class="headerlink" title="配置和启动 kube-controller-manager"></a>配置和启动 kube-controller-manager</h3><p>创建 kube-controller-manager的serivce配置文件:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Kubernetes Controller Manager</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;github.com&#x2F;GoogleCloudPlatform&#x2F;kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;kubernetes&#x2F;config</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;kubernetes&#x2F;controller-manager</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;kube-controller-manager \</span><br><span class="line">      $KUBE_LOGTOSTDERR \</span><br><span class="line">            $KUBE_LOG_DIR \</span><br><span class="line">      $KUBE_LOG_LEVEL \</span><br><span class="line">      $KUBE_MASTER \</span><br><span class="line">      $KUBE_CONTROLLER_MANAGER_ARGS</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">LimitNOFILE&#x3D;65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure></div>

<p>配置文件/etc/kubernetes/controller-manager</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">###</span><br><span class="line"># The following values are used to configure the kubernetes controller-manager</span><br><span class="line"></span><br><span class="line"># defaults from config and apiserver should be adequate</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBE_CONTROLLER_MANAGER_ARGS&#x3D;&quot;--address&#x3D;127.0.0.1 --service-cluster-ip-range&#x3D;10.254.0.0&#x2F;16 --cluster-name&#x3D;kubernetes --cluster-signing-cert-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem --cluster-signing-key-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca-key.pem  --service-account-private-key-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca-key.pem --root-ca-file&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem --leader-elect&#x3D;true --use-service-account-credentials&#x3D;true --controllers&#x3D;*,bootstrapsigner,tokencleaner --allocate-node-cidrs&#x3D;true --cluster-cidr&#x3D;192.168.0.0&#x2F;16&quot;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>–service-cluster-ip-range 参数指定 Cluster 中 Service 的CIDR范围，该网络在各 Node 间必须路由不可达，必须和 kube-apiserver 中的参数一致；</li>
<li>-cluster-signing-* 指定的证书和私钥文件用来签名为 TLS BootStrap 创建的证书和私钥；</li>
<li>–root-ca-file 用来对 kube-apiserver 证书进行校验，指定该参数后，才会在Pod 容器的 ServiceAccount 中放置该 CA 证书文件；</li>
<li>–address 值必须为 127.0.0.1，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器</li>
</ul>
<p>启动 kube-controller-manager</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl enable kube-controller-manager</span><br><span class="line">$ systemctl start kube-controller-manager</span><br></pre></td></tr></table></figure></div>

<h3 id="启动-kube-controller-manager"><a href="#启动-kube-controller-manager" class="headerlink" title="启动 kube-controller-manager"></a>启动 kube-controller-manager</h3><p>创建 kube-scheduler的serivce配置文件,文件路径/usr/lib/systemd/system/kube-scheduler.service</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Kubernetes Scheduler Plugin</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;github.com&#x2F;GoogleCloudPlatform&#x2F;kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;kubernetes&#x2F;config</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;kubernetes&#x2F;scheduler</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;kube-scheduler \</span><br><span class="line">            $KUBE_LOGTOSTDERR \</span><br><span class="line">            $KUBE_LOG_LEVEL \</span><br><span class="line">            $KUBE_MASTER \</span><br><span class="line">            $KUBE_SCHEDULER_ARGS</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">LimitNOFILE&#x3D;65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure></div>

<p>配置文件/etc/kubernetes/scheduler</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">###</span><br><span class="line"># kubernetes scheduler config</span><br><span class="line"></span><br><span class="line"># default config should be adequate</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBE_SCHEDULER_ARGS&#x3D;&quot;--leader-elect&#x3D;true --address&#x3D;127.0.0.1&quot;</span><br></pre></td></tr></table></figure></div>

<p>启动 kube-scheduler</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl enable kube-scheduler</span><br><span class="line">$ systemctl start kube-scheduler</span><br></pre></td></tr></table></figure></div>

<p>验证 master 节点功能</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get componentstatuses</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="安装kubectl命令行工具"><a href="#安装kubectl命令行工具" class="headerlink" title="安装kubectl命令行工具"></a>安装kubectl命令行工具</h2><p>创建 kubectl kubeconfig 文件</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ export KUBE_APISERVER&#x3D;&quot;https:&#x2F;&#x2F;172.172.168.0.25:6443&quot;</span><br><span class="line">$ # 设置集群参数</span><br><span class="line">$ kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;$&#123;KUBE_APISERVER&#125;</span><br><span class="line">$ # 设置客户端认证参数</span><br><span class="line">$ kubectl config set-credentials admin \</span><br><span class="line">  --client-certificate&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;admin.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --client-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;admin-key.pem</span><br><span class="line">$ # 设置上下文参数</span><br><span class="line">$ kubectl config set-context kubernetes \</span><br><span class="line">  --cluster&#x3D;kubernetes \</span><br><span class="line">  --user&#x3D;admin</span><br><span class="line">$ # 设置默认上下文</span><br><span class="line">$ kubectl config use-context kubernetes</span><br></pre></td></tr></table></figure></div>

<ul>
<li>admin.pem 证书 OU 字段值为 system:masters，kube-apiserver 预定义的 RoleBinding cluster-admin 将 Group system:masters 与 Role cluster-admin 绑定，该 Role 授予了调用kube-apiserver 相关 API 的权限</li>
<li>生成的 kubeconfig 被保存到 ~/.kube/config 文件</li>
</ul>
<h2 id="创建-kubeconfig-文件"><a href="#创建-kubeconfig-文件" class="headerlink" title="创建 kubeconfig 文件"></a>创建 kubeconfig 文件</h2><p>kubelet、kube-proxy 等 Node 机器上的进程与 Master 机器的 kube-apiserver 进程通信时需要认证和授权;<br>kubernetes 1.4 开始支持由 kube-apiserver 为客户端生成 TLS 证书的 TLS Bootstrapping 功能，这样就不需要为每个客户端生成证书了；该功能当前仅支持为 kubelet 生成证书；</p>
<h3 id="创建-TLS-Bootstrapping-Token"><a href="#创建-TLS-Bootstrapping-Token" class="headerlink" title="创建 TLS Bootstrapping Token"></a>创建 TLS Bootstrapping Token</h3><p>Token auth file<br>Token可以是任意的包涵128 bit的字符串，可以使用安全的随机数发生器生成</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export BOOTSTRAP_TOKEN&#x3D;$(head -c 16 &#x2F;dev&#x2F;urandom | od -An -t x | tr -d &#39; &#39;)</span><br><span class="line">cat &gt; token.csv &lt;&lt;EOF</span><br><span class="line">$&#123;BOOTSTRAP_TOKEN&#125;,kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></div>

<p>BOOTSTRAP_TOKEN 将被写入到 kube-apiserver 使用的 token.csv 文件和 kubelet 使用的 bootstrap.kubeconfig 文件，如果后续重新生成了 BOOTSTRAP_TOKEN，则需要：</p>
<ul>
<li>更新 token.csv 文件，分发到所有机器 (master 和 node）的 /etc/kubernetes/ 目录下，分发到node节点上非必需</li>
<li>重新生成 bootstrap.kubeconfig 文件，分发到所有 node 机器的 /etc/kubernetes/ 目录下</li>
<li>重启 kube-apiserver 和 kubelet 进程</li>
<li>重新 approve kubelet 的 csr 请求</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$cp token.csv &#x2F;etc&#x2F;kubernetes&#x2F;</span><br></pre></td></tr></table></figure></div>

<h3 id="创建-kubelet-bootstrapping-kubeconfig-文件"><a href="#创建-kubelet-bootstrapping-kubeconfig-文件" class="headerlink" title="创建 kubelet bootstrapping kubeconfig 文件"></a>创建 kubelet bootstrapping kubeconfig 文件</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ cd &#x2F;etc&#x2F;kubernetes</span><br><span class="line">$ export KUBE_APISERVER&#x3D;&quot;https:&#x2F;&#x2F;172.172.168.0.25:6443&quot;</span><br><span class="line">$ # 设置集群参数</span><br><span class="line">$ kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig&#x3D;bootstrap.kubeconfig</span><br><span class="line">$ # 设置客户端认证参数</span><br><span class="line">$ kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token&#x3D;$&#123;BOOTSTRAP_TOKEN&#125; \</span><br><span class="line">  --kubeconfig&#x3D;bootstrap.kubeconfig</span><br><span class="line">$ # 设置上下文参数</span><br><span class="line">$ kubectl config set-context default \</span><br><span class="line">  --cluster&#x3D;kubernetes \</span><br><span class="line">  --user&#x3D;kubelet-bootstrap \</span><br><span class="line">  --kubeconfig&#x3D;bootstrap.kubeconfig</span><br><span class="line">$ # 设置默认上下文</span><br><span class="line">$ kubectl config use-context default --kubeconfig&#x3D;bootstrap.kubeconfig</span><br></pre></td></tr></table></figure></div>

<ul>
<li>–embed-certs 为 true 时表示将 certificate-authority 证书写入到生成的 bootstrap.kubeconfig 文件中</li>
<li>设置客户端认证参数时没有指定秘钥和证书，后续由 kube-apiserver 自动生成</li>
</ul>
<h3 id="创建-kube-proxy-kubeconfig-文件"><a href="#创建-kube-proxy-kubeconfig-文件" class="headerlink" title="创建 kube-proxy kubeconfig 文件"></a>创建 kube-proxy kubeconfig 文件</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ export KUBE_APISERVER&#x3D;&quot;https:&#x2F;&#x2F;172.172.168.0.25:6443&quot;</span><br><span class="line">$ # 设置集群参数</span><br><span class="line">$ kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;ca.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --server&#x3D;$&#123;KUBE_APISERVER&#125; \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line">$ # 设置客户端认证参数</span><br><span class="line">$ kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kube-proxy.pem \</span><br><span class="line">  --client-key&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kube-proxy-key.pem \</span><br><span class="line">  --embed-certs&#x3D;true \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line">$ # 设置上下文参数</span><br><span class="line">$ kubectl config set-context default \</span><br><span class="line">  --cluster&#x3D;kubernetes \</span><br><span class="line">  --user&#x3D;kube-proxy \</span><br><span class="line">  --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br><span class="line">$ # 设置默认上下文</span><br><span class="line">$ kubectl config use-context default --kubeconfig&#x3D;kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure></div>

<ul>
<li>设置集群参数和客户端认证参数时 –embed-certs 都为 true，这会将 certificate-authority、client-certificate 和 client-key 指向的证书文件内容写入到生成的 kube-proxy.kubeconfig 文件中</li>
<li>kube-proxy.pem 证书中 CN 为 system:kube-proxy，kube-apiserver 预定义的 RoleBinding cluster-admin 将User system:kube-proxy 与 Role system:node-proxier 绑定，该 Role 授予了调用 kube-apiserver Proxy 相关 API 的权限；</li>
</ul>
<h3 id="分发-kubeconfig-文件"><a href="#分发-kubeconfig-文件" class="headerlink" title="分发 kubeconfig 文件"></a>分发 kubeconfig 文件</h3><p>将两个 kubeconfig 文件分发到所有 Node 机器的 /etc/kubernetes/ 目录</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp bootstrap.kubeconfig kube-proxy.kubeconfig &#x2F;etc&#x2F;kubernetes&#x2F;</span><br></pre></td></tr></table></figure></div>

<h2 id="部署node节点"><a href="#部署node节点" class="headerlink" title="部署node节点"></a>部署node节点</h2><h3 id="安装和配置-kubelet"><a href="#安装和配置-kubelet" class="headerlink" title="安装和配置 kubelet"></a>安装和配置 kubelet</h3><p>kubelet 启动时向 kube-apiserver 发送 TLS bootstrapping 请求，需要先将 bootstrap token 文件中的 kubelet-bootstrap 用户赋予 system:node-bootstrapper cluster 角色(role)， 然后 kubelet 才能有权限创建认证请求(certificate signing requests)</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap \</span><br><span class="line">  --clusterrole&#x3D;system:node-bootstrapper \</span><br><span class="line">  --user&#x3D;kubelet-bootstrap</span><br></pre></td></tr></table></figure></div>

<ul>
<li>–user=kubelet-bootstrap 是在 /etc/kubernetes/token.csv 文件中指定的用户名，同时也写入了 /etc/kubernetes/bootstrap.kubeconfig 文件；<br>创建 kubelet 的service配置文件，文件位置/usr/lib/systemd/system/kubelet.service</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Kubernetes Kubelet Server</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;github.com&#x2F;GoogleCloudPlatform&#x2F;kubernetes</span><br><span class="line">After&#x3D;docker.service</span><br><span class="line">Requires&#x3D;docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory&#x3D;&#x2F;var&#x2F;lib&#x2F;kubelet</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;kubernetes&#x2F;config</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;kubernetes&#x2F;kubelet</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;kubelet \</span><br><span class="line">            $KUBE_LOGTOSTDERR \</span><br><span class="line">            $KUBE_LOG_DIR \</span><br><span class="line">            $KUBE_LOG_LEVEL \</span><br><span class="line">            $KUBELET_API_SERVER \</span><br><span class="line">            $KUBELET_ADDRESS \</span><br><span class="line">            $KUBELET_PORT \</span><br><span class="line">            $KUBELET_HOSTNAME \</span><br><span class="line">            $KUBE_ALLOW_PRIV \</span><br><span class="line">            $KUBELET_POD_INFRA_CONTAINER \</span><br><span class="line">            $KUBELET_ARGS</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure></div>

<p>kubelet的配置文件/etc/kubernetes/kubelet。其中的IP地址更改为你的每台node节点的IP地址<br>注意：/var/lib/kubelet需要手动创建，否则可能导致kubelet启动失败</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">###</span><br><span class="line">## kubernetes kubelet (minion) config</span><br><span class="line">#</span><br><span class="line">## The address for the info server to serve on (set to 0.0.0.0 or &quot;&quot; for all interfaces)</span><br><span class="line">KUBELET_ADDRESS&#x3D;&quot;--address&#x3D;172.168.0.25&quot;</span><br><span class="line">#</span><br><span class="line">## The port for the info server to serve on</span><br><span class="line">#KUBELET_PORT&#x3D;&quot;--port&#x3D;10250&quot;</span><br><span class="line">#</span><br><span class="line">## You may leave this blank to use the actual hostname</span><br><span class="line">KUBELET_HOSTNAME&#x3D;&quot;--hostname-override&#x3D;qinweiwei-1&quot;</span><br><span class="line">#</span><br><span class="line">## location of the api-server</span><br><span class="line">#KUBELET_API_SERVER&#x3D;&quot;--api-servers&#x3D;http:&#x2F;&#x2F;172.168.0.25:8080&quot;</span><br><span class="line">#</span><br><span class="line">## pod infrastructure container</span><br><span class="line">KUBELET_POD_INFRA_CONTAINER&#x3D;&quot;--pod-infra-container-image&#x3D;gcr.io&#x2F;google_containers&#x2F;pause-amd64:3.0&quot;</span><br><span class="line">#</span><br><span class="line">## Add your own!</span><br><span class="line">KUBELET_ARGS&#x3D;&quot;--cgroup-driver&#x3D;systemd --cluster-dns&#x3D;10.254.0.2 --experimental-bootstrap-kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;bootstrap.kubeconfig --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;kubelet.kubeconfig --require-kubeconfig --cert-dir&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;ssl --cluster-domain&#x3D;cluster.local.--serialize-image-pulls&#x3D;false --network-plugin&#x3D;cni --cni-conf-dir&#x3D;&#x2F;etc&#x2F;cni&#x2F;net.d --cni-bin-dir&#x3D;&#x2F;opt&#x2F;cni&#x2F;bin&quot;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>–address 不能设置为 127.0.0.1，否则后续 Pods 访问 kubelet 的 API 接口时会失败，因为 Pods 访问的 127.0.0.1 指向自己而不是 kubelet</li>
<li>如果设置了 –hostname-override 选项，则 kube-proxy 也需要设置该选项，否则会出现找不到 Node 的情况</li>
<li>–experimental-bootstrap-kubeconfig 指向 bootstrap kubeconfig 文件，kubelet 使用该文件中的用户名和 token 向 kube-apiserver 发送 TLS Bootstrapping 请求</li>
<li>管理员通过了 CSR 请求后，kubelet 自动在 –cert-dir 目录创建证书和私钥文件(kubelet-client.crt 和 kubelet-client.key)，然后写入 –kubeconfig 文件</li>
<li>建议在 –kubeconfig 配置文件中指定 kube-apiserver 地址，如果未指定 –api-servers 选项，则必须指定 –require-kubeconfig 选项后才从配置文件中读取 kube-apiserver 的地址，否则 kubelet 启动后将找不到 kube-apiserver (日志中提示未找到 API Server），kubectl get nodes 不会返回对应的 Node 信息</li>
<li>—kubeconfig=/etc/kubernetes/kubelet.kubeconfig中指定的kubelet.kubeconfig文件在第一次启动kubelet之前并不存在，请看下文，当通过CSR请求后会自动生成kubelet.kubeconfig文件，如果你的节点上已经生成了<del>/.kube/config文件，你可以将该文件拷贝到该路径下，并重命名为kubelet.kubeconfig，所有node节点可以共用同一个kubelet.kubeconfig文件，这样新添加的节点就不需要再创建CSR请求就能自动添加到kubernetes集群中。同样，在任意能够访问到kubernetes集群的主机上使用kubectl —kubeconfig命令操作集群时，只要使用</del>/.kube/config文件就可以通过权限认证，因为这里面已经有认证信息并认为你是admin用户，对集群拥有所有权限。</li>
<li>使用calico网络时，需要配置cni相关参数</li>
</ul>
<h3 id="启动kublet"><a href="#启动kublet" class="headerlink" title="启动kublet"></a>启动kublet</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl enable kubelet</span><br><span class="line">$ systemctl start kubelet</span><br><span class="line">$ systemctl status kubelet</span><br></pre></td></tr></table></figure></div>

<h3 id="通过-kublet-的-TLS-证书请求"><a href="#通过-kublet-的-TLS-证书请求" class="headerlink" title="通过 kublet 的 TLS 证书请求"></a>通过 kublet 的 TLS 证书请求</h3><p>kubelet 首次启动时向 kube-apiserver 发送证书签名请求，必须通过后 kubernetes 系统才会将该 Node 加入到集群。</p>
<p>查看未授权的 CSR 请求</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get csr</span><br><span class="line">NAME        AGE       REQUESTOR           CONDITION</span><br><span class="line">csr-2b308   4m        kubelet-bootstrap   Pending</span><br><span class="line">$ kubectl get nodes</span><br><span class="line">No resources found.</span><br></pre></td></tr></table></figure></div>

<p>通过 CSR 请求</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl certificate approve csr-2b308</span><br><span class="line">certificatesigningrequest &quot;csr-2b308&quot; approved</span><br><span class="line">$ kubectl get nodes</span><br><span class="line">NAME        STATUS    AGE       VERSION</span><br><span class="line">10.64.3.7   Ready     49m       v1.7.3</span><br></pre></td></tr></table></figure></div>

<p>自动生成了 kubelet kubeconfig 文件和公私钥</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l &#x2F;etc&#x2F;kubernetes&#x2F;kubelet.kubeconfig</span><br><span class="line">-rw------- 1 root root 2284 Apr  7 02:07 &#x2F;etc&#x2F;kubernetes&#x2F;kubelet.kubeconfig</span><br><span class="line">$ ls -l &#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubelet*</span><br><span class="line">-rw-r--r-- 1 root root 1046 Apr  7 02:07 &#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubelet-client.crt</span><br><span class="line">-rw------- 1 root root  227 Apr  7 02:04 &#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubelet-client.key</span><br><span class="line">-rw-r--r-- 1 root root 1103 Apr  7 02:07 &#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubelet.crt</span><br><span class="line">-rw------- 1 root root 1675 Apr  7 02:07 &#x2F;etc&#x2F;kubernetes&#x2F;ssl&#x2F;kubelet.key</span><br></pre></td></tr></table></figure></div>

<p>注意：假如你更新kubernetes的证书，只要没有更新token.csv，当重启kubelet后，该node就会自动加入到kuberentes集群中，而不会重新发送certificaterequest，也不需要在master节点上执行kubectl certificate approve操作。前提是不要删除node节点上的/etc/kubernetes/ssl/kubelet*和/etc/kubernetes/kubelet.kubeconfig文件。否则kubelet启动时会提示找不到证书而失败。</p>
<h3 id="配置-kube-proxy"><a href="#配置-kube-proxy" class="headerlink" title="配置 kube-proxy"></a>配置 kube-proxy</h3><p>创建 kube-proxy 的service配置文件</p>
<p>文件路径/usr/lib/systemd/system/kube-proxy.service</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description&#x3D;Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation&#x3D;https:&#x2F;&#x2F;github.com&#x2F;GoogleCloudPlatform&#x2F;kubernetes</span><br><span class="line">After&#x3D;network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;kubernetes&#x2F;config</span><br><span class="line">EnvironmentFile&#x3D;-&#x2F;etc&#x2F;kubernetes&#x2F;proxy</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;kube-proxy \</span><br><span class="line">      $KUBE_LOGTOSTDERR \</span><br><span class="line">            $KUBE_LOG_DIR \</span><br><span class="line">      $KUBE_LOG_LEVEL \</span><br><span class="line">      $KUBE_MASTER \</span><br><span class="line">      $KUBE_PROXY_ARGS</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">LimitNOFILE&#x3D;65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure></div>

<p>kube-proxy配置文件/etc/kubernetes/proxy</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">###</span><br><span class="line"># kubernetes proxy config</span><br><span class="line"></span><br><span class="line"># default config should be adequate</span><br><span class="line"></span><br><span class="line"># Add your own!</span><br><span class="line">KUBE_PROXY_ARGS&#x3D;&quot;--bind-address&#x3D;172.168.0.25  --kubeconfig&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;kube-proxy.kubeconfig --cluster-cidr&#x3D;10.254.0.0&#x2F;16 --proxy-mode&#x3D;iptables&quot;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>–hostname-override 参数值必须与 kubelet 的值一致，否则 kube-proxy 启动后会找不到该 Node，从而不会创建任何 iptables 规则；</li>
<li>kube-proxy 根据 –cluster-cidr 判断集群内部和外部流量，指定 –cluster-cidr 或 –masquerade-all 选项后 kube-proxy 才会对访问 Service IP 的请求做 SNAT；</li>
<li>–kubeconfig 指定的配置文件嵌入了 kube-apiserver 的地址、用户名、证书、秘钥等请求和认证信息；<br>预定义的 RoleBinding cluster-admin 将User system:kube-proxy 与 Role system:node-proxier 绑定，该 Role 授予了调用 kube-apiserver Proxy 相关 API 的权限；</li>
</ul>
<h3 id="启动-kube-proxy"><a href="#启动-kube-proxy" class="headerlink" title="启动 kube-proxy"></a>启动 kube-proxy</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl enable kube-proxy</span><br><span class="line">$ systemctl start kube-proxy</span><br><span class="line">$ systemctl status kube-proxy</span><br></pre></td></tr></table></figure></div>

<h2 id="部署calico"><a href="#部署calico" class="headerlink" title="部署calico"></a>部署calico</h2><h3 id="下载calico相关的docker镜像"><a href="#下载calico相关的docker镜像" class="headerlink" title="下载calico相关的docker镜像"></a>下载calico相关的docker镜像</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull quay.io&#x2F;calico&#x2F;cni:v1.10.0</span><br><span class="line">docker pull quay.io&#x2F;calico&#x2F;kube-policy-controller:v0.7.0</span><br><span class="line">docker pull quay.io&#x2F;calico&#x2F;node:v2.5.1</span><br></pre></td></tr></table></figure></div>

<h3 id="构建RBAC"><a href="#构建RBAC" class="headerlink" title="构建RBAC"></a>构建RBAC</h3><blockquote>
<p>kubectl apply -f <a href="https://docs.projectcalico.org/v2.5/getting-started/kubernetes/installation/rbac.yaml" target="_blank" rel="noopener">https://docs.projectcalico.org/v2.5/getting-started/kubernetes/installation/rbac.yaml</a></p>
</blockquote>
<h3 id="安装calico"><a href="#安装calico" class="headerlink" title="安装calico"></a>安装calico</h3><ul>
<li>下载calico.yaml文件</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line"># Calico Version v2.5.1</span><br><span class="line"># https:&#x2F;&#x2F;docs.projectcalico.org&#x2F;v2.5&#x2F;releases#v2.5.1</span><br><span class="line"># This manifest includes the following component versions:</span><br><span class="line">#   calico&#x2F;node:v2.5.1</span><br><span class="line">#   calico&#x2F;cni:v1.10.0</span><br><span class="line">#   calico&#x2F;kube-policy-controller:v0.7.0</span><br><span class="line"></span><br><span class="line"># This ConfigMap is used to configure a self-hosted Calico installation.</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: calico-config</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  # Configure this with the location of your etcd cluster.</span><br><span class="line">  etcd_endpoints: &quot;http:&#x2F;&#x2F;127.0.0.1:2379&quot;</span><br><span class="line"></span><br><span class="line">  # Configure the Calico backend to use.</span><br><span class="line">  calico_backend: &quot;bird&quot;</span><br><span class="line"></span><br><span class="line">  # The CNI network configuration to install on each node.</span><br><span class="line">  cni_network_config: |-</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;name&quot;: &quot;k8s-pod-network&quot;,</span><br><span class="line">        &quot;cniVersion&quot;: &quot;0.1.0&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;calico&quot;,</span><br><span class="line">        &quot;etcd_endpoints&quot;: &quot;__ETCD_ENDPOINTS__&quot;,</span><br><span class="line">        &quot;etcd_key_file&quot;: &quot;__ETCD_KEY_FILE__&quot;,</span><br><span class="line">        &quot;etcd_cert_file&quot;: &quot;__ETCD_CERT_FILE__&quot;,</span><br><span class="line">        &quot;etcd_ca_cert_file&quot;: &quot;__ETCD_CA_CERT_FILE__&quot;,</span><br><span class="line">        &quot;log_level&quot;: &quot;info&quot;,</span><br><span class="line">        &quot;mtu&quot;: 1500,</span><br><span class="line">        &quot;ipam&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;calico-ipam&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;policy&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;k8s_api_root&quot;: &quot;https:&#x2F;&#x2F;__KUBERNETES_SERVICE_HOST__:__KUBERNETES_SERVICE_PORT__&quot;,</span><br><span class="line">            &quot;k8s_auth_token&quot;: &quot;__SERVICEACCOUNT_TOKEN__&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;kubernetes&quot;: &#123;</span><br><span class="line">            &quot;kubeconfig&quot;: &quot;__KUBECONFIG_FILEPATH__&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  # If you&#39;re using TLS enabled etcd uncomment the following.</span><br><span class="line">  # You must also populate the Secret below with these files.</span><br><span class="line">  etcd_ca: &quot;&quot;   # &quot;&#x2F;calico-secrets&#x2F;etcd-ca&quot;</span><br><span class="line">  etcd_cert: &quot;&quot; # &quot;&#x2F;calico-secrets&#x2F;etcd-cert&quot;</span><br><span class="line">  etcd_key: &quot;&quot;  # &quot;&#x2F;calico-secrets&#x2F;etcd-key&quot;</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"># The following contains k8s Secrets for use with a TLS enabled etcd cluster.</span><br><span class="line"># For information on populating Secrets, see http:&#x2F;&#x2F;kubernetes.io&#x2F;docs&#x2F;user-guide&#x2F;secrets&#x2F;</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">type: Opaque</span><br><span class="line">metadata:</span><br><span class="line">  name: calico-etcd-secrets</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  # Populate the following files with etcd TLS configuration if desired, but leave blank if</span><br><span class="line">  # not using TLS for etcd.</span><br><span class="line">  # This self-hosted install expects three files with the following names.  The values</span><br><span class="line">  # should be base64 encoded strings of the entire contents of each file.</span><br><span class="line">  # etcd-key: null</span><br><span class="line">  # etcd-cert: null</span><br><span class="line">  # etcd-ca: null</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"># This manifest installs the calico&#x2F;node container, as well</span><br><span class="line"># as the Calico CNI plugins and network config on</span><br><span class="line"># each master and worker node in a Kubernetes cluster.</span><br><span class="line">kind: DaemonSet</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: calico-node</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: calico-node</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: calico-node</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: calico-node</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io&#x2F;critical-pod: &#39;&#39;</span><br><span class="line">        scheduler.alpha.kubernetes.io&#x2F;tolerations: |</span><br><span class="line">          [&#123;&quot;key&quot;: &quot;dedicated&quot;, &quot;value&quot;: &quot;master&quot;, &quot;effect&quot;: &quot;NoSchedule&quot; &#125;,</span><br><span class="line">           &#123;&quot;key&quot;:&quot;CriticalAddonsOnly&quot;, &quot;operator&quot;:&quot;Exists&quot;&#125;]</span><br><span class="line">    spec:</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      serviceAccountName: calico-node</span><br><span class="line">      containers:</span><br><span class="line">        # Runs calico&#x2F;node container on each Kubernetes node.  This</span><br><span class="line">        # container programs network policy and routes on each</span><br><span class="line">        # host.</span><br><span class="line">        - name: calico-node</span><br><span class="line">          image: quay.io&#x2F;calico&#x2F;node:v2.5.1</span><br><span class="line">          env:</span><br><span class="line">            # The location of the Calico etcd cluster.</span><br><span class="line">            - name: ETCD_ENDPOINTS</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: etcd_endpoints</span><br><span class="line">            # Choose the backend to use.</span><br><span class="line">            - name: CALICO_NETWORKING_BACKEND</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: calico_backend</span><br><span class="line">            # Cluster type to identify the deployment type</span><br><span class="line">            - name: CLUSTER_TYPE</span><br><span class="line">              value: &quot;k8s,bgp&quot;</span><br><span class="line">            # Disable file logging so &#96;kubectl logs&#96; works.</span><br><span class="line">            - name: CALICO_DISABLE_FILE_LOGGING</span><br><span class="line">              value: &quot;true&quot;</span><br><span class="line">            # Set Felix endpoint to host default action to ACCEPT.</span><br><span class="line">            - name: FELIX_DEFAULTENDPOINTTOHOSTACTION</span><br><span class="line">              value: &quot;ACCEPT&quot;</span><br><span class="line">            # Configure the IP Pool from which Pod IPs will be chosen.</span><br><span class="line">            - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">              value: &quot;192.168.0.0&#x2F;16&quot;</span><br><span class="line">            - name: CALICO_IPV4POOL_IPIP</span><br><span class="line">              value: &quot;always&quot;</span><br><span class="line">            # Disable IPv6 on Kubernetes.</span><br><span class="line">            - name: FELIX_IPV6SUPPORT</span><br><span class="line">              value: &quot;false&quot;</span><br><span class="line">            # Set Felix logging to &quot;info&quot;</span><br><span class="line">            - name: FELIX_LOGSEVERITYSCREEN</span><br><span class="line">              value: &quot;info&quot;</span><br><span class="line">            # Set MTU for tunnel device used if ipip is enabled</span><br><span class="line">            - name: FELIX_IPINIPMTU</span><br><span class="line">              value: &quot;1440&quot;</span><br><span class="line">            # Location of the CA certificate for etcd.</span><br><span class="line">            - name: ETCD_CA_CERT_FILE</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: etcd_ca</span><br><span class="line">            # Location of the client key for etcd.</span><br><span class="line">            - name: ETCD_KEY_FILE</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: etcd_key</span><br><span class="line">            # Location of the client certificate for etcd.</span><br><span class="line">            - name: ETCD_CERT_FILE</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: etcd_cert</span><br><span class="line">            # Auto-detect the BGP IP address.</span><br><span class="line">            - name: IP</span><br><span class="line">              value: &quot;&quot;</span><br><span class="line">            - name: FELIX_HEALTHENABLED</span><br><span class="line">              value: &quot;true&quot;</span><br><span class="line">          securityContext:</span><br><span class="line">            privileged: true</span><br><span class="line">          resources:</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 250m</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: &#x2F;liveness</span><br><span class="line">              port: 9099</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            initialDelaySeconds: 10</span><br><span class="line">            failureThreshold: 6</span><br><span class="line">          readinessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: &#x2F;readiness</span><br><span class="line">              port: 9099</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - mountPath: &#x2F;lib&#x2F;modules</span><br><span class="line">              name: lib-modules</span><br><span class="line">              readOnly: true</span><br><span class="line">            - mountPath: &#x2F;var&#x2F;run&#x2F;calico</span><br><span class="line">              name: var-run-calico</span><br><span class="line">              readOnly: false</span><br><span class="line">            - mountPath: &#x2F;calico-secrets</span><br><span class="line">              name: etcd-certs</span><br><span class="line">        # This container installs the Calico CNI binaries</span><br><span class="line">        # and CNI network config file on each node.</span><br><span class="line">        - name: install-cni</span><br><span class="line">          image: quay.io&#x2F;calico&#x2F;cni:v1.10.0</span><br><span class="line">          command: [&quot;&#x2F;install-cni.sh&quot;]</span><br><span class="line">          env:</span><br><span class="line">            # The location of the Calico etcd cluster.</span><br><span class="line">            - name: ETCD_ENDPOINTS</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: etcd_endpoints</span><br><span class="line">            # The CNI network config to install on each node.</span><br><span class="line">            - name: CNI_NETWORK_CONFIG</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: cni_network_config</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - mountPath: &#x2F;host&#x2F;opt&#x2F;cni&#x2F;bin</span><br><span class="line">              name: cni-bin-dir</span><br><span class="line">            - mountPath: &#x2F;host&#x2F;etc&#x2F;cni&#x2F;net.d</span><br><span class="line">              name: cni-net-dir</span><br><span class="line">            - mountPath: &#x2F;calico-secrets</span><br><span class="line">              name: etcd-certs</span><br><span class="line">      volumes:</span><br><span class="line">        # Used by calico&#x2F;node.</span><br><span class="line">        - name: lib-modules</span><br><span class="line">          hostPath:</span><br><span class="line">            path: &#x2F;lib&#x2F;modules</span><br><span class="line">        - name: var-run-calico</span><br><span class="line">          hostPath:</span><br><span class="line">            path: &#x2F;var&#x2F;run&#x2F;calico</span><br><span class="line">        # Used to install CNI.</span><br><span class="line">        - name: cni-bin-dir</span><br><span class="line">          hostPath:</span><br><span class="line">            path: &#x2F;opt&#x2F;cni&#x2F;bin</span><br><span class="line">        - name: cni-net-dir</span><br><span class="line">          hostPath:</span><br><span class="line">            path: &#x2F;etc&#x2F;cni&#x2F;net.d</span><br><span class="line">        # Mount in the etcd TLS secrets.</span><br><span class="line">        - name: etcd-certs</span><br><span class="line">          secret:</span><br><span class="line">            secretName: calico-etcd-secrets</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"># This manifest deploys the Calico policy controller on Kubernetes.</span><br><span class="line"># See https:&#x2F;&#x2F;github.com&#x2F;projectcalico&#x2F;k8s-policy</span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: calico-policy-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: calico-policy</span><br><span class="line">  annotations:</span><br><span class="line">    scheduler.alpha.kubernetes.io&#x2F;critical-pod: &#39;&#39;</span><br><span class="line">    scheduler.alpha.kubernetes.io&#x2F;tolerations: |</span><br><span class="line">      [&#123;&quot;key&quot;: &quot;dedicated&quot;, &quot;value&quot;: &quot;master&quot;, &quot;effect&quot;: &quot;NoSchedule&quot; &#125;,</span><br><span class="line">       &#123;&quot;key&quot;:&quot;CriticalAddonsOnly&quot;, &quot;operator&quot;:&quot;Exists&quot;&#125;]</span><br><span class="line">spec:</span><br><span class="line">  # The policy controller can only have a single active instance.</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: calico-policy-controller</span><br><span class="line">      namespace: kube-system</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: calico-policy</span><br><span class="line">    spec:</span><br><span class="line">      # The policy controller must run in the host network namespace so that</span><br><span class="line">      # it isn&#39;t governed by policy that would prevent it from working.</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      serviceAccountName: calico-policy-controller</span><br><span class="line">      containers:</span><br><span class="line">        - name: calico-policy-controller</span><br><span class="line">          image: quay.io&#x2F;calico&#x2F;kube-policy-controller:v0.7.0</span><br><span class="line">          env:</span><br><span class="line">            # The location of the Calico etcd cluster.</span><br><span class="line">            - name: ETCD_ENDPOINTS</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: etcd_endpoints</span><br><span class="line">            # Location of the CA certificate for etcd.</span><br><span class="line">            - name: ETCD_CA_CERT_FILE</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: etcd_ca</span><br><span class="line">            # Location of the client key for etcd.</span><br><span class="line">            - name: ETCD_KEY_FILE</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: etcd_key</span><br><span class="line">            # Location of the client certificate for etcd.</span><br><span class="line">            - name: ETCD_CERT_FILE</span><br><span class="line">              valueFrom:</span><br><span class="line">                configMapKeyRef:</span><br><span class="line">                  name: calico-config</span><br><span class="line">                  key: etcd_cert</span><br><span class="line">            # The location of the Kubernetes API.  Use the default Kubernetes</span><br><span class="line">            # service for API access.</span><br><span class="line">            - name: K8S_API</span><br><span class="line">              value: &quot;https:&#x2F;&#x2F;kubernetes.default:443&quot;</span><br><span class="line">            # Since we&#39;re running in the host namespace and might not have KubeDNS</span><br><span class="line">            # access, configure the container&#39;s &#x2F;etc&#x2F;hosts to resolve</span><br><span class="line">            # kubernetes.default to the correct service clusterIP.</span><br><span class="line">            - name: CONFIGURE_ETC_HOSTS</span><br><span class="line">              value: &quot;true&quot;</span><br><span class="line">          volumeMounts:</span><br><span class="line">            # Mount in the etcd TLS secrets.</span><br><span class="line">            - mountPath: &#x2F;calico-secrets</span><br><span class="line">              name: etcd-certs</span><br><span class="line">      volumes:</span><br><span class="line">        # Mount in the etcd TLS secrets.</span><br><span class="line">        - name: etcd-certs</span><br><span class="line">          secret:</span><br><span class="line">            secretName: calico-etcd-secrets</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: calico-policy-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: calico-node</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div>

<ul>
<li>修改<code>etcd_endpoints</code>字段为实际的etcd地址</li>
<li>对于tls的etcd需要修改以下配置</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: calico-config</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  etcd_endpoints: &quot;https:&#x2F;&#x2F;172.168.0.25:2379&quot;</span><br><span class="line">  ......</span><br><span class="line">  etcd_ca: &quot;&#x2F;calico-secrets&#x2F;etcd-ca&quot;</span><br><span class="line">  etcd_cert: &quot;&#x2F;calico-secrets&#x2F;etcd-cert&quot;</span><br><span class="line">  etcd_key: &quot;&#x2F;calico-secrets&#x2F;etcd-key&quot;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">type: Opaque</span><br><span class="line">metadata:</span><br><span class="line">  name: calico-etcd-secrets</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  # 通过base64编码后的值</span><br><span class="line">  etcd-key: &quot;&quot;</span><br><span class="line">  etcd-cert: &quot;&quot;</span><br><span class="line">  etcd-ca: &quot;&quot;</span><br></pre></td></tr></table></figure></div>
<p><em>注意</em>： 通过base64编码可以通过命令获取</p>
<blockquote>
<p>kubectl create secret generic helloworld-tls –from-file=/etc/kubernetes/ssl/kubernetes.pem –from-file=/etc/kubernetes/ssl/kubernetes-key.pem –from-file=/etc/kubernetes/ssl/ca.pem<br>kubectl get secret helloworld-tls -o yaml<br>对于kubernetes宿主机为虚机时，使用calico ipip模式的通信时pod间网络可能不通，需要主机虚机的安全组规则是否允许ip协议为ipip的通过（ipv4.proto == 4）</p>
</blockquote>
<h2 id="安装addon组件"><a href="#安装addon组件" class="headerlink" title="安装addon组件"></a>安装addon组件</h2><h3 id="安装kube-dns"><a href="#安装kube-dns" class="headerlink" title="安装kube-dns"></a>安装kube-dns</h3><p>在kubernetes目录<code>kubernetes/cluster/addons/dns</code>下有kube-dns的yaml部署文件，只需要关注kubedns-controller.yaml.sed, kubedns-svc.yaml.sed, kubedns-sa.yaml, kubedns-cm.yaml四个文件。从<code>kubernetes/centos/deployAddons.sh</code>脚本可以看出, 修改yaml.sed文件中的DNS_DOMAIN和DNS_SERVER_IP为实际的值后，即可以直接部署kube-dns</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sed -e &quot;s&#x2F;\\\$DNS_DOMAIN&#x2F;$&#123;DNS_DOMAIN&#125;&#x2F;g&quot; &quot;$&#123;KUBE_ROOT&#125;&#x2F;cluster&#x2F;addons&#x2F;dns&#x2F;kubedns-controller.yaml.sed&quot; &gt; kubedns-controller.yaml</span><br><span class="line">sed -e &quot;s&#x2F;\\\$DNS_SERVER_IP&#x2F;$&#123;DNS_SERVER_IP&#125;&#x2F;g&quot; &quot;$&#123;KUBE_ROOT&#125;&#x2F;cluster&#x2F;addons&#x2F;dns&#x2F;kubedns-svc.yaml.sed&quot; &gt; kubedns-svc.yaml</span><br><span class="line">KUBEDNS&#x3D;&#96;eval &quot;$&#123;KUBECTL&#125; get services --namespace&#x3D;kube-system | grep kube-dns | cat&quot;&#96;</span><br><span class="line"></span><br><span class="line">if [ ! &quot;$KUBEDNS&quot; ]; then</span><br><span class="line">  # use kubectl to create kube-dns deployment and service</span><br><span class="line">  $&#123;KUBECTL&#125; --namespace&#x3D;kube-system create -f kubedns-sa.yaml</span><br><span class="line">  $&#123;KUBECTL&#125; --namespace&#x3D;kube-system create -f kubedns-cm.yaml</span><br><span class="line">  $&#123;KUBECTL&#125; --namespace&#x3D;kube-system create -f kubedns-controller.yaml</span><br><span class="line">  $&#123;KUBECTL&#125; --namespace&#x3D;kube-system create -f kubedns-svc.yaml</span><br><span class="line"></span><br><span class="line">  echo &quot;Kube-dns deployment and service is successfully deployed.&quot;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>注意DNS_DOMAIN和DNS_SERVER_IP的值需要跟kubelet的配置项<code>--cluster-domain</code>和<code>--cluster-dns</code>保持一致。</li>
</ul>
<h3 id="安装dashboard"><a href="#安装dashboard" class="headerlink" title="安装dashboard"></a>安装dashboard</h3><p>在<code>kubernetes/cluster/addons/dashboard</code>目录下有部署dashboard的yaml文件，直接部署即可，另外除了<code>dashboard-controller.yaml</code>和<code>dashboard-service.yaml</code>这两个文件，还应该增加rbac的yaml文件，否则dashboard启动时会报权限的错误</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dashboard</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: dashboard</span><br><span class="line">    namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure></div>
<h3 id="安装heapster"><a href="#安装heapster" class="headerlink" title="安装heapster"></a>安装heapster</h3><ul>
<li>从git库上下载heapser</li>
<li>在<code>heapster/deploy/kube-config/influxdb</code>目录修改heapster.yaml和grafana.yaml文件service的类型为NodePort用于通过nodeport方式访问</li>
<li>执行<code>kubectl create -f .</code></li>
<li>在<code>heapster/deploy/kube-config/rbac</code>目录下执行<code>kubectl create -f heapster-rbac.yaml</code></li>
</ul>
<h3 id="安装ingress-nginx-Controller"><a href="#安装ingress-nginx-Controller" class="headerlink" title="安装ingress-nginx Controller"></a>安装ingress-nginx Controller</h3><p>直接按照官网文档上直接安装即可 <a href="https://github.com/kubernetes/ingress-nginx/tree/master/deploy" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx/tree/master/deploy</a></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;ingress-nginx&#x2F;master&#x2F;deploy&#x2F;namespace.yaml | kubectl apply -f -</span><br><span class="line">curl https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;ingress-nginx&#x2F;master&#x2F;deploy&#x2F;default-backend.yaml | kubectl apply -f -</span><br><span class="line">curl https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;ingress-nginx&#x2F;master&#x2F;deploy&#x2F;configmap.yaml | kubectl apply -f -</span><br><span class="line">curl https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;ingress-nginx&#x2F;master&#x2F;deploy&#x2F;tcp-services-configmap.yaml | kubectl apply -f -</span><br><span class="line">curl https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;ingress-nginx&#x2F;master&#x2F;deploy&#x2F;udp-services-configmap.yaml | kubectl apply -f -</span><br><span class="line">curl https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;ingress-nginx&#x2F;master&#x2F;deploy&#x2F;rbac.yaml | kubectl apply -f -</span><br><span class="line">curl https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;ingress-nginx&#x2F;master&#x2F;deploy&#x2F;with-rbac.yaml | kubectl apply -f -</span><br><span class="line">使用NodePort方式访问</span><br><span class="line">curl https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;ingress-nginx&#x2F;master&#x2F;deploy&#x2F;provider&#x2F;baremetal&#x2F;service-nodeport.yaml | kubectl apply -f -</span><br></pre></td></tr></table></figure></div>

<p>创建ingress资源</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: guestbook</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io&#x2F;rewrite-target: &#x2F;</span><br><span class="line">    nginx.ingress.kubernetes.io&#x2F;add-base-url: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: k8s.test</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;aa</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: frontend</span><br><span class="line">          servicePort: 80</span><br><span class="line">      - path: &#x2F;nginx</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: nginx</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure></div>

<p>有些情况，访问ingress的资源时报出404错误，需要在ingress的yaml中加上</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io&#x2F;rewrite-target: &#x2F;</span><br><span class="line">nginx.ingress.kubernetes.io&#x2F;add-base-url: &quot;true&quot;</span><br></pre></td></tr></table></figure></div>

<p>具体可见<a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/rewrite/README.md" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/rewrite/README.md</a></p>
</div></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/kubernetes/">kubernetes    </a></div><div class="post_share"></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2018/02/16/kubernetes-calico-network-location-progress/"><img class="prev_cover lazyload" data-src="https://cdn.pixabay.com/photo/2016/05/04/13/16/processor-1371357_1280.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>kubernetes集群中calico网络不通的问题定位过程记录</span></div></a></div><div class="next-post pull_right"><a href="/2018/01/15/kubeadm-source-analysis/"><img class="next_cover lazyload" data-src="https://cdn.pixabay.com/photo/2015/10/18/18/07/android-994910_1280.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>kubeadm源码分析</span></div></a></div></nav></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By Eric Qin</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>